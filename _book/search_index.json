[
["n2-confusion.html", "N2 confusion Chapter 1 N2 confusion", " N2 confusion Chapter 1 N2 confusion #graphics.off(); # &lt;-- no plots are shown if not commented rm(list=ls()) # example ctd if (F) { dataname &lt;- &quot;example_ctd&quot; data(ctd) z &lt;- ctd@data$depth # m, positive downward --&gt; need abs() in dz calc below p &lt;- ctd@data$pressure # dbar t_insitu &lt;- ctd@data$temperature sp &lt;- ctd@data$salinity lon &lt;- ctd@metadata$longitude lat &lt;- ctd@metadata$latitude # levitus } else if (T) { dataname &lt;- &quot;woa18&quot; t_insitu_woa_ncin &lt;- nc_open(&quot;/work/ba0941/a270073/data/WOA/2018/woa18_decav_t00_04.nc&quot;) sp_woa_ncin &lt;- nc_open(&quot;/work/ba0941/a270073/data/WOA/2018/woa18_decav_s00_04.nc&quot;) lons &lt;- t_insitu_woa_ncin$dim$lon$val # -180,...,180Â° lats &lt;- t_insitu_woa_ncin$dim$lat$val z &lt;- t_insitu_woa_ncin$dim$depth$vals # m, positive downward --&gt; need abs() in dz calc below select_from_lon_lat &lt;- c(lon=-20, lat=47.4) select_from_inds &lt;- c(which.min(abs(lons - select_from_lon_lat[&quot;lon&quot;])), which.min(abs(lats - select_from_lon_lat[&quot;lat&quot;]))) lon &lt;- lons[select_from_inds[1]] lat &lt;- lats[select_from_inds[2]] message(&quot;lon: &quot;, lon) message(&quot;lat: &quot;, lat) p &lt;- gsw_p_from_z(z=-z, latitude=lat) # dbar sp &lt;- ncvar_get(sp_woa_ncin, &quot;s_an&quot;, start=c(select_from_inds[1], select_from_inds[2], 1, 1), count=c(1, 1, length(p), 1)) t_insitu &lt;- ncvar_get(t_insitu_woa_ncin, &quot;t_an&quot;, start=c(select_from_inds[1], select_from_inds[2], 1, 1), count=c(1, 1, length(p), 1)) # remove NA at depth if (any(is.na(sp))) { inds &lt;- which(is.na(sp)) z &lt;- z[-inds] p &lt;- p[-inds] sp &lt;- sp[-inds] t_insitu &lt;- t_insitu[-inds] } } ## lon: -20.125 ## lat: 47.375 sa &lt;- gsw_SA_from_SP(SP=sp, p=p, long=lon, lat=lat) ct &lt;- gsw_CT_from_t(SA=sa, t=t_insitu, p=p) # default TEOS-10 way to calc N2 message(&quot;calc gsw N2 with locally referenced density ...&quot;) ## calc gsw N2 with locally referenced density ... N2_gsw &lt;- gsw_Nsquared(SA=sa, CT=ct, p=p, latitude=lat) # using reference pressures to calc N2 g &lt;- gsw_grav(latitude=lat, p=p) ps &lt;- c(0, 1000, 2000, 3000, 4000) # dbar N2_own &lt;- array(NA, c(length(p) - 1, length(ps))) colnames(N2_own) &lt;- paste0(ps, &quot;dbar&quot;) p_mid_own &lt;- (p[2:length(p)] + p[1:(length(p)-1)])/2 print(identical(N2_gsw$p_mid, p_mid_own)) ## [1] TRUE sa_at_p_mid &lt;- (sa[2:length(p)] + sa[1:(length(p)-1)])/2 ct_at_p_mid &lt;- (ct[2:length(p)] + ct[1:(length(p)-1)])/2 rho_insitu_at_pmid &lt;- gsw_rho(SA=sa_at_p_mid, CT=ct_at_p_mid, p=p_mid_own) # upper minus lower dz &lt;- abs(z[1:(length(z)-1)] - z[2:length(z)]) for (pp in 1:length(ps)) { message(&quot;calc own N2 with ref pressure &quot;, ps[pp], &quot; dbar ...&quot;) rho_pot &lt;- gsw_rho(SA=sa, CT=ct, p=ps[pp]) # upper minus lower drho_pot &lt;- rho_pot[1:(length(rho_pot)-1)] - rho_pot[2:length(rho_pot)] N2_own[,pp] &lt;- -g/rho_insitu_at_pmid * drho_pot/dz } ## calc own N2 with ref pressure 0 dbar ... ## calc own N2 with ref pressure 1000 dbar ... ## calc own N2 with ref pressure 2000 dbar ... ## calc own N2 with ref pressure 3000 dbar ... ## calc own N2 with ref pressure 4000 dbar ... # plot #png(paste0(&quot;n2_confusion_&quot;, dataname, &quot;.png&quot;), width=3000, height=2000, res=400) par(mfrow=c(1, 3)) # absolute N2 xlim &lt;- range(N2_gsw$N2[is.finite(N2_gsw$N2)], N2_own[is.finite(N2_own)]) # s-2 ylim &lt;- rev(range(p)) # dbar plot(N2_gsw$N2, N2_gsw$p_mid, xlim=xlim, ylim=ylim, t=&quot;l&quot;, xlab=&quot;N2 [s-2]&quot;, ylab=&quot;pressure [dbar]&quot;, yaxt=&quot;n&quot;, lwd=2) axis(2, las=2) for (pp in 1:length(ps)) { lines(N2_own[,pp], N2_gsw$p_mid, col=pp+1, lty=pp+1) } legend(&quot;bottomright&quot;, c(&quot;GSW&quot;, paste0(&quot;p_ref=&quot;, ps, &quot; dbar&quot;)), col=c(&quot;black&quot;, 1+(1:length(ps))), lty=c(1, 1+(1:length(ps))), bty=&quot;n&quot;) # N2 anomaly own minus gsw N2_anom &lt;- N2_own - replicate(N2_gsw$N2, n=length(ps)) xlim &lt;- range(N2_anom, na.rm=T) # s-2 ylim &lt;- rev(range(p)) # dbar plot(N2_anom[,1], N2_gsw$p_mid, xlim=xlim, ylim=ylim, t=&quot;n&quot;, xlab=&quot;N2 anomaly [s-2]\\n=(own minus GSW)&quot;, ylab=&quot;pressure [dbar]&quot;, yaxt=&quot;n&quot;) axis(2, las=2) for (pp in 1:length(ps)) { lines(N2_anom[,pp], N2_gsw$p_mid, col=pp+1, lty=pp+1) } # N2 anomaly own minus gsw as percentage of N2 gsw N2_anom_percent &lt;- N2_anom/replicate(N2_gsw$N2, n=length(ps))*100 xlim &lt;- range(N2_anom_percent, na.rm=T) # % ylim &lt;- rev(range(p)) # dbar plot(N2_anom_percent[,1], N2_gsw$p_mid, xlim=xlim, ylim=ylim, t=&quot;n&quot;, xlab=&quot;N2 anomaly [% of GSW]\\n=(own minus GSW)/GSW*100&quot;, ylab=&quot;pressure [dbar]&quot;, yaxt=&quot;n&quot;) axis(2, las=2) for (pp in 1:length(ps)) { lines(N2_anom_percent[,pp], N2_gsw$p_mid, col=pp+1, lty=pp+1) } #dev.off() "]
]
